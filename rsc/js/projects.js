import*as bootstrap from"bootstrap";import{initPagination}from"./pagination.js";import{getPlaceholderForStack}from"./placeholderBuilder.js";import{filterProjByTitle,filterByDate,createTruncatedSpan}from"./gallery-sorting.js";import{getIcon,renderOneStackIcon}from"./stackIconLoader.js";import{filterProjectsBySearchTerm}from"./search.js";import{projectsPerPage}from"./perPageSettings.js";import{parseMermaidCode}from"./json-parser.js";import panzoom from"panzoom";import mermaid from"mermaid";window.mermaid=mermaid;export let allProjects=[];const MAX_STACK_CHARS=20;mermaid.initialize({startOnLoad:!1}),document.addEventListener("DOMContentLoaded",(function(){document.getElementById("projectsGallery")?(console.log("Projects gallery found, initializing projects"),initializeProjects()):console.log("No projects gallery found, skipping initialization")}));export function loadProjects(){return console.log("Loading projects..."),tryFetchPaths([(window.location.hostname.includes("github.io")?"/Personal-Static/":"/")+"rsc/json/projects.json","./rsc/json/projects.json","/rsc/json/projects.json","rsc/json/projects.json"]).then((e=>(console.log(`Projects data received: ${e.length} items`),allProjects=e,e))).catch((e=>{console.error("Project loading error:",e);const t=document.getElementById("projectsGallery");return t&&(t.innerHTML=`<div class="error">Failed to load projects: ${e.message}</div>`),[]}))}async function tryFetchPaths(e){for(const t of e)try{console.log(`Trying to fetch from: ${t}`);const e=await fetch(t);if(e.ok)return console.log(`Successfully loaded from: ${t}`),e.json()}catch(e){console.log(`Failed attempt with path: ${t}`)}throw new Error("All paths failed")}export function renderProjectsGallery(e){const t=document.getElementById("projectsGallery");if(!t)return void console.log("No projects gallery found on this page - skipping render");t.innerHTML="";const o=document.getElementById("projectCardTemplate");e.forEach((e=>{const n=o.content.cloneNode(!0).querySelector(".project-card");n.dataset.projectId=e.id;const a=n.querySelector(".project-thumbnail");a.src=e.thumbnail||"images/placeholder.jpg",a.alt=e.title;const s=n.querySelector(".date-label"),l=e.date||e.dates||"No date";s.textContent=l,s.dataset.tooltip=l,setupTooltipEvents(s);const r=n.querySelector(".academic-label");r.textContent=e.academic?"Academic":"Personal",r.classList.add(e.academic?"academic":"personal"),setupTooltipEvents(r,l),setupBadges(n,e),n.querySelector(".project-title").textContent=e.title;const i=e.shortForm||e.description||"",c=n.querySelector(".short-form-truncated");i.length>100?(c.textContent=i.slice(0,97)+"...",c.title=i):c.textContent=i,setupStackIcons(n.querySelector(".stack-icons"),e.stack),n.addEventListener("click",(()=>{openProjectModal(e.id)})),t.appendChild(n)}))}function setupTooltipEvents(e,t=null){e.addEventListener("mouseover",(()=>{let o=e.querySelector(".tooltip-date");o||(o=document.createElement("div"),o.className="tooltip-date",o.innerHTML=`<span style="color:white; display:inline-block;">${t||e.dataset.tooltip}</span>`,o.style.backgroundColor="rgba(0, 0, 0, 0.8)",o.style.padding="5px 8px",o.style.zIndex="100",e.appendChild(o),o.offsetWidth),o.classList.add("visible")})),e.addEventListener("mouseout",(()=>{const t=e.querySelector(".tooltip-date");t&&t.classList.remove("visible")}))}function setupBadges(e,t){const o=e.querySelector(".badge-container"),n=o.querySelector(".image-count-icon");t.images&&t.images.length>1&&(n.style.display="block",n.querySelector(".count").textContent=t.images.length);const a=o.querySelector(".mermaid-icon");t.mermaid&&t.mermaid.trim()&&(a.style.display="block")}function setupStackIcons(e,t){const o=document.getElementById("stackItemTemplate"),n=document.getElementById("moreStackTemplate"),{items:a,remaining:s}=getVisibleStackItems(t);if(a.forEach((t=>{const n=o.content.cloneNode(!0).querySelector(".stack-icon");n.textContent=t,e.appendChild(n)})),s>0){const o=n.content.cloneNode(!0).querySelector(".more-link");o.textContent=`+${s} more`,o.addEventListener("click",(n=>{n.stopPropagation(),expandStack(e,t,a.length,o)})),e.appendChild(o)}}function buildDateTooltip(e){return e?`\n    <div>\n      <strong>Started:</strong> ${e.started||"N/A"}<br>\n      <strong>Modified:</strong> ${e.modified||"N/A"}<br>\n      <strong>Completed:</strong> ${e.completed||e.released||"N/A"}\n    </div>\n  `:"No date info available."}function expandStack(e,t,o,n){e.removeChild(n),t.slice(o).forEach((t=>{const o=document.createElement("span");o.classList.add("stack-icon"),o.textContent=t,e.appendChild(o)}));const a=e.closest(".project-card");if(a){const e=a.querySelector(".academic-label");e&&("none"===e.style.display?e.style.display="":e.style.display="none")}}function showImagesInModal(e){const t=document.getElementById("modalImages");t.classList.remove("mermaid-view"),t.classList.add("images-view");const o=document.getElementById("projectImageCarousel"),n=t.querySelector(".fallback-placeholder"),a=document.getElementById("mermaidContainer"),s=t.querySelector(".no-mermaid");if(o&&(o.style.display="none"),n&&(n.style.display="none"),a&&(a.style.display="none"),s&&(s.style.display="none"),e.images&&e.images.length>0&&o){const n=o.querySelector(".carousel-inner");if(n){n.innerHTML="";const a=document.getElementById("carouselItemTemplate");e.images.forEach(((e,t)=>{const o=a.content.cloneNode(!0).querySelector(".carousel-item");0===t&&o.classList.add("active");const s=o.querySelector("img"),l=o.querySelector("a"),r=e.startsWith("rsc/")||e.startsWith("http")?e:e.includes("/")?`rsc/images/${e}`:`rsc/images/recipes/${e}`;l.href=r,l.target="_blank",l.rel="noopener",l.removeAttribute("data-lightbox"),s.src=r,s.alt=`Project image ${t+1}`,s.style.maxHeight="350px",s.style.width="auto",s.style.margin="0 auto",s.style.objectFit="contain",n.appendChild(o)})),o.style.display="block",o.style.maxHeight="375px",t.style.display="block";try{bootstrap.Carousel.getInstance(o)?.dispose(),new bootstrap.Carousel(o,{interval:!1,wrap:!0}),setTimeout((()=>{window.lightbox&&window.lightbox.option({resizeDuration:200,wrapAround:!0,alwaysShowNavOnTouchDevices:!0,disableScrolling:!0}),o.querySelectorAll("a[data-lightbox]").forEach((e=>{(new Image).src=e.href,e.addEventListener("click",(t=>{t.preventDefault(),window.lightbox||window.open(e.href,"_blank")}))}))}),200)}catch(e){console.warn("Error initializing carousel or lightbox:",e)}}}else{const o=n.querySelector("img");o&&(o.src=getPlaceholderForStack(e),o.style.maxHeight="350px",o.style.width="auto"),n.style.display="block",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center"}}function showMermaidDiagramInModal(e){const t=document.getElementById("modalImages"),o=document.getElementById("mermaidContainer"),n=document.getElementById("projectImageCarousel"),a=t.querySelector(".fallback-placeholder"),s=t.querySelector(".no-mermaid");n&&(n.style.display="none"),a&&(a.style.display="none"),t.classList.remove("images-view"),t.classList.add("mermaid-view"),t.style.display="block";const l=parseMermaidCode(e);if(!l||!l.trim())return o&&(o.style.display="none"),void(s&&(s.style.display="block"));if(o){o.innerHTML="";const e=document.createElement("div");e.className="mermaid",e.textContent=l,o.appendChild(e),o.style.display="block",setTimeout((()=>{try{window.mermaid?(window.mermaid.initialize({startOnLoad:!1,securityLevel:"loose"}),window.mermaid.init(void 0,e).then((()=>{console.log("Mermaid diagram rendered successfully"),setTimeout((()=>{try{const t=e.querySelector("svg");t&&(t.style.border="1px solid #ddd",t.style.borderRadius="4px",t.style.padding="10px",t.style.width="100%",t.style.height="auto",panzoom(t,{smoothScroll:!1,maxZoom:5,minZoom:.5,boundsPadding:.1}))}catch(e){console.error("Panzoom error:",e)}}),300)})).catch((t=>{console.error("Mermaid initialization error:",t),e.textContent="Error rendering diagram. Check your mermaid syntax.",e.style.color="red"}))):(console.error("Mermaid library not available"),e.textContent="Mermaid library failed to load.",e.style.color="red")}catch(t){console.error("Error initializing Mermaid:",t),e.textContent="Error rendering diagram: "+t.message,e.style.color="red"}}),200)}}function setupModalToggleFABs(e){const t=e,o=document.querySelector(".fab-container");o&&o.remove();const n=document.createElement("div");n.className="fab-container";const a=document.createElement("button");a.className="fab toggle-images",a.innerHTML='<img src="rsc/images/fab-image-icon.png" alt="Images" style="width:24px; height:24px;">',a.classList.add("selected");const s=document.createElement("button");s.className="fab toggle-mermaid";const l=window.location.hostname.includes("github.io")?"/Personal-Static/":"/";s.innerHTML=`<img src="${l}rsc/images/stack/MermaidJS.png" alt="Mermaid Diagram" />`,s.style.position="relative",e.mermaid&&e.mermaid.trim()||(s.setAttribute("disabled","true"),s.classList.add("disabled")),s.addEventListener("click",(()=>{let e=s.querySelector(".fab-tooltip");if(!e){e=document.createElement("div"),e.className="fab-tooltip",e.textContent="drag and scroll to explore the ERD",s.appendChild(e);const t=e.offsetHeight||30;e.style.position="absolute",e.style.top=`-${t+5}px`,e.style.left="50%",e.style.transform="translateX(-50%)",e.style.zIndex="20000",e.offsetWidth,e.classList.add("show"),setTimeout((()=>{e.classList.remove("show"),setTimeout((()=>{e.remove()}),500)}),3e3)}})),s.addEventListener("mouseleave",(()=>{const e=s.querySelector(".fab-tooltip");e&&setTimeout((()=>{e.remove()}),500)})),a.addEventListener("click",(()=>{a.classList.add("selected"),s.classList.remove("selected"),showImagesInModal(t)})),s.addEventListener("click",(()=>{s.disabled||(s.classList.add("selected"),a.classList.remove("selected"),showMermaidDiagramInModal(t))})),n.appendChild(a),n.appendChild(s);const r=document.getElementById("modalStack");r&&r.parentNode&&r.parentNode.insertBefore(n,r.nextSibling)}function initializeFABs(e){const t=document.querySelector(".modal-top"),o=document.querySelector(".toggle-mermaid"),n=document.querySelector(".toggle-images"),a=document.getElementById("modalImages");if(!e.mermaid||!e.mermaid.trim())return void(o&&o.classList.add("disabled"));let s="images";o&&o.addEventListener("click",(()=>{if("images"===s&&!o.classList.contains("disabled")){t.classList.add("mermaid-expanded");const l=document.querySelector(".modal-section-heading");l&&l.classList.add("heading-hidden");const r=a.querySelector("#projectImageCarousel, .fallback-placeholder");r&&(r.style.display="none"),o.classList.add("selected"),n.classList.remove("selected"),s="mermaid",setTimeout((()=>{showMermaidDiagramInModal(e)}),300)}})),n&&n.addEventListener("click",(()=>{if("mermaid"===s){const a=document.getElementById("mermaidContainer");a&&(a.style.display="none"),t.classList.remove("mermaid-expanded");const l=document.querySelector(".modal-section-heading");l&&l.classList.remove("heading-hidden"),setTimeout((()=>{showImagesInModal(e),n.classList.add("selected"),o.classList.remove("selected"),s="images"}),300)}}))}export function openProjectModal(e){const t=allProjects.find((t=>t.id===e));if(!t)return void console.error("Project not found:",e);document.getElementById("projectModal").style.display="block",document.getElementById("modalTitle").textContent=t.title,showImagesInModal(t);const o=document.getElementById("modalStack");o.innerHTML="";const n=document.getElementById("stackIconContainerTemplate");t.stack.forEach((e=>{const t=n.content.cloneNode(!0).querySelector(".stack-item-container");t.dataset.tech=e;const a=getIcon(e),s=t.querySelector(".stack-image"),l=t.querySelector(".stack-label");if(a)s.src=a;else{const t=window.location.hostname.includes("github.io")?"/Personal-Static/":"/";s.src=`${t}rsc/images/stack/${e.toLowerCase()}.png`}s.alt=e,l.textContent=e,o.appendChild(t)})),setupModalToggleFABs(t),initializeFABs(t),document.getElementById("projectStatus").textContent=`Status: ${t.status||"N/A"}`,document.getElementById("projectDates").textContent=`Dates: ${t.dates||"Unknown"}`,document.getElementById("modalDescription").innerHTML=t.description||"No description available"}export function closeModal(){document.getElementById("projectModal").style.display="none";const e=document.querySelector(".fab-container");e&&e.remove(),document.getElementById("modalTitle").innerText="",document.getElementById("modalDescription").innerText="",document.getElementById("modalStack").innerHTML="";const t=document.getElementById("projectImageCarousel");if(t){const e=t.querySelector(".carousel-inner");e&&(e.innerHTML=""),t.style.display="none"}const o=document.getElementById("modalImages");if(o){const e=o.querySelector(".fallback-placeholder");e&&(e.style.display="none");const t=document.getElementById("mermaidContainer");t&&(t.style.display="none",t.innerHTML="");const n=o.querySelector(".no-mermaid");n&&(n.style.display="none")}}function getVisibleStackItems(e){let t=0,o=[];for(const n of e){if(!(t+n.length<=20))break;t+=n.length,o.push(n)}return{items:o,remaining:e.length-o.length}}function initializeProjects(){loadTemplates().then((()=>(console.log("Templates loaded successfully"),loadProjects()))).then(renderProjectsGallery).then((()=>{console.log("Projects loaded and rendered")})).catch((e=>{console.error("Failed to initialize projects:",e)}));const e=document.getElementById("closeModal");e&&e.addEventListener("click",closeModal);const t=document.getElementById("projectModal");t&&t.addEventListener("click",(e=>{e.target===t&&closeModal()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&closeModal()}))}function loadTemplates(){const e=window.location.hostname.includes("github.io")?"/Personal-Static/":"/",t=[{path:`${e}htmlModules/project-card.html`,id:"templateContainer-projectCard"},{path:`${e}htmlModules/stack-item-template.html`,id:"templateContainer-stackItems"}].map((e=>fetch(e.path).then((t=>{if(!t.ok)throw new Error(`Failed to load template: ${e.path}`);return t.text()})).then((t=>{const o=document.createElement("div");o.id=e.id,o.style.display="none",o.innerHTML=t,document.body.appendChild(o),console.log(`Loaded template: ${e.path}`)}))));return Promise.all(t)}